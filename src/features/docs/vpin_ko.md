# VPIN (거래량 동기화 정보 거래 확률)

## 개요

VPIN은 **주문 흐름 독성(order flow toxicity)**의 실시간 추정치이다 — 시장 조성자가 정보를 가진 상대방과 거래하고 있을 확률을 측정한다. Easley, López de Prado, O'Hara (2012)가 개발했으며, 2010년 5월 6일 Flash Crash 수 시간 전에 높아진 독성을 감지한 것으로 유명하다.

OHLCV 바를 생성하는 TIBS/TRBS/VIBS와 달리, VPIN은 현재 주문 흐름이 얼마나 "독성"이 있는지를 측정하는 연속 지표(0~1)를 생성한다. 높은 VPIN = 높은 정보 거래 확률 = 시장 조성자에게 위험.

## VPIN을 사용하는 이유

- **조기 경보 시스템**: VPIN의 급등은 종종 큰 가격 변동과 변동성 이벤트에 선행한다.
- **시장 레짐 감지**: 정보 거래 vs 비정보 거래 흐름 레짐을 구분한다.
- **리스크 관리**: 독성이 높아지면 보호 조치(스프레드 확대, 포지션 축소)를 트리거할 수 있다.
- **거래량-시간 샘플링**: 동일 거래량 버킷을 사용하여 다양한 활동 수준을 정규화한다.

## 수학적 기초

### 1단계: 동일 거래량 버킷

거래는 고정 명목 거래량 `V` (호가 통화 기준, 예: USD)의 버킷에 축적된다. 이전 버킷의 누적 명목 (`Σ price × quantity`)이 `V`에 도달하면 새 버킷이 시작된다.

```
버킷 닫기 조건: Σ(price_t × qty_t) ≥ V
```

### 2단계: 대량 거래량 분류 (Bulk Volume Classification, BVC)

개별 거래를 매수/매도로 분류하는 대신, BVC는 버킷 전체의 가격 변화를 사용하여 거래량을 확률적으로 할당한다. 가격 변화 `ΔP`를 가진 닫힌 버킷에 대해:

```
ΔP = 종가 - 이전_버킷_종가
σ  = 최근 `sigma_window`개 버킷의 ΔP 표준편차
z  = ΔP / σ

V_buy  = V × Φ(z)
V_sell = V × (1 - Φ(z)) = V - V_buy
```

여기서 `Φ(z)`는 표준 정규 CDF이다.

직관: 가격이 올랐으면(양의 ΔP) 더 많은 거래량이 매수 주도로 분류된다. 최근 변동성(σ) 대비 크기가 분류의 극단성을 결정한다.

### 3단계: 주문 불균형

각 버킷의 절대 주문 불균형:

```
OI = |V_buy - V_sell| = |2·V_buy - V|
```

### 4단계: 롤링 VPIN

VPIN은 최근 `n`개 버킷의 평균 주문 불균형을 `V`로 정규화한 것이다:

```
VPIN = (최근 n개 버킷의 Σ OI_i) / (n × V)
```

VPIN 범위: 0 (완벽히 균형) ~ 1 (완전히 한쪽).

## 하이퍼파라미터

| 파라미터 | CLI 플래그 | 기본값 | 설명 |
|---------|-----------|--------|------|
| 버킷 거래량 (V) | `--v` | 10,000 | 호가 통화(USD/USDT) 기준 버킷당 명목 거래량. V가 클수록 부드럽지만 느림. |
| 롤링 윈도우 (n) | `--n` | 50 | VPIN 롤링 평균의 버킷 수. n이 클수록 VPIN이 부드러움. |
| 시그마 윈도우 | `--sigma-window` | 20 | σ 추정을 위한 과거 가격 변화 수. 최소 2 이상. |
| 시그마 하한 | `--sigma-floor` | 1e-12 | 저변동성 기간에 0으로 나누기 방지를 위한 최소 σ. |

### 하이퍼파라미터 튜닝 가이드

- **V (버킷 거래량)**: 상품의 일반적인 명목 거래량에 맞게 교정해야 한다. BTC/USDT의 경우 `V = 10,000`은 거래된 ~$10,000당 하나의 버킷을 의미한다. 유동성이 낮은 상품은 V를 줄이고, 높으면 늘린다. 경험 법칙: 하루에 수백 개의 버킷이 생기는 것이 좋다.
- **n (롤링 윈도우)**: 부드러움 vs 반응성의 트레이드오프를 제어한다. 하루 ~200개 버킷에 `n = 50`이면 약 6시간의 롤링 윈도우가 된다. 빠른 신호를 원하면 줄이고(더 많은 노이즈), 부드러운 것을 원하면 늘린다(더 많은 지연).
- **sigma_window**: 안정적인 σ 추정을 위해 충분히 커야 하고(≥20), 레짐 변화에 적응할 수 있을 만큼 작아야 한다.

## 출력

VPIN 출력은 기존 영속화 파이프라인과의 호환성을 위해 `Candle` protobuf 메시지로 인코딩된다:

| 필드 | 내용 |
|------|------|
| `symbol` | 거래 쌍 |
| `timestamp` | 버킷 시작 시간 (밀리초) |
| `open`, `high`, `low`, `close` | 버킷 내 OHLC 가격 |
| `volume` | V (설정된 버킷 거래량, 상수) |
| `interval` | 설정 인코딩 (예: `vpin_V10000_n50_sw20`) |
| `buy_ticks` | 0 (VPIN에서는 의미 없음) |
| `sell_ticks` | 0 (VPIN에서는 의미 없음) |
| `total_ticks` | 버킷 내 거래 건수 |
| `theta` | **VPIN 값** (0.0 ~ 1.0) |

VPIN 값은 새로운 proto 필드를 추가하지 않기 위해 `theta` 필드에 담겨 있다.

## 구현 세부사항

### 워밍업 기간

VPIN이 값을 방출하기 전에 워밍업 기간이 필요하다:
1. 첫 번째 버킷은 ΔP를 계산하기 위한 `prev_close`가 필요하므로 첫 번째 버킷은 무출력이다.
2. σ를 계산하기 전에 `sigma_window`개의 버킷이 필요하다.
3. 롤링 VPIN 평균이 가득 차기 전에 `n`개의 버킷이 필요하다.

총 워밍업: ~(`sigma_window` + `n`) 버킷.

### CDF 근사

표준 정규 CDF `Φ(x)`는 Abramowitz & Stegun (1964)의 `erf(x)` 근사를 사용하여 계산된다. 빠르고 충분히 정확하다 (최대 오차 ~1.5×10⁻⁷).

### 시딩

첫 번째 관찰된 거래 가격이 `prev_close`를 시드하는 데 사용된다. 시드되기 전까지는 유효한 ΔP 값을 생성할 수 없다.

## 해석

| VPIN 범위 | 해석 |
|----------|------|
| 0.0 – 0.3 | 낮은 독성 — 균형 잡힌 흐름, 시장 조성에 안전 |
| 0.3 – 0.5 | 보통 — 일부 정보 활동 |
| 0.5 – 0.7 | 상승 — 정보 거래 확률 증가 |
| 0.7 – 1.0 | 높은 독성 — 강한 정보 흐름, 역선택 위험 |

이 범위는 근사적이며, 상품과 시장에 따라 교정해야 한다.

## 영속화

VPIN 버킷은 TimescaleDB의 `warehouse.bar__vpin` 테이블에 저장된다. `interval` 컬럼에 설정 파라미터가 인코딩되어 식별에 사용된다.

## 참고 문헌

- Easley, D., López de Prado, M.M., & O'Hara, M. (2012). Flow Toxicity and Liquidity in a High-frequency World. *Review of Financial Studies*, 25(5), 1457–1493.
- Easley, D., López de Prado, M.M., & O'Hara, M. (2011). The Microstructure of the "Flash Crash": Flow Toxicity, Liquidity Crashes, and the Probability of Informed Trading. *Journal of Portfolio Management*, 37(2), 118–128.
- López de Prado, M. (2018). *Advances in Financial Machine Learning*. Wiley. 19장: Microstructural Features.
