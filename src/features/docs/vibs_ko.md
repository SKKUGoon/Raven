# 거래량 불균형 바 (Volume Imbalance Bars, VIBS)

## 개요

거래량 불균형 바(VIBS)는 틱 불균형 개념을 확장하여, 각 틱을 균일하게 세는 대신 **거래량**으로 가중치를 부여한다. 이는 각 거래의 경제적 중요성을 포착한다: 100 BTC 매수는 1 BTC 매수보다 불균형 신호에 100배 더 기여한다. 누적 *부호 있는 거래량*이 동적으로 조정되는 임계값을 초과하면 바가 닫힌다.

## VIBS를 사용하는 이유

- **거래량 가중 신호**: 대규모 거래가 바 닫기 트리거에 비례적으로 더 많은 가중치를 갖으며, 더 큰 시장 영향을 반영한다.
- **기관 흐름 감지에 유리**: 기관 주문은 종종 더 큰 규모로 거래된다. VIBS는 이러한 신호를 자연스럽게 증폭한다.
- **노이즈 감소**: 소규모 개인 거래는 불균형에 최소한으로 기여하여, 모든 틱을 동일하게 세는 TIBS에 비해 노이즈가 감소한다.
- **적응적**: 임계값이 삼중 EWMA (바 크기, 매수 확률, 틱당 평균 거래량)를 통해 조정된다.

## 수학적 기초

### 부호 있는 거래량

각 거래는 부호 있는 거래량으로 기여한다:

```
v_t × b_t
```

여기서:
- `v_t` = 거래 수량 (거래량)
- `b_t` = +1.0 (매수) 또는 -1.0 (매도)

### 누적 거래량 불균형 (Theta)

```
θ_T = Σ(t=1..T) v_t × b_t
```

이는 순 방향성 거래량이다: 양수는 매수 거래량이 더 많음을, 음수는 매도 거래량이 더 많음을 의미한다.

### 바 닫기 조건

다음 조건이 충족되면 바가 닫힌다:

```
|θ_T| > |E[T] × E[v] × (2·E[p_buy] - 1)|
```

여기서:
- `E[T]` = 바당 예상 틱 수 (EWMA)
- `E[v]` = 틱당 예상 거래량 (EWMA)
- `E[p_buy]` = 예상 매수 확률 (EWMA)
- `(2·E[p_buy] - 1)` = 각 틱의 예상 방향

임계값은 현재 시장 레짐에서의 바당 예상 *순 거래량*을 반영한다.

### EWMA 업데이트 (각 바 닫힘 후)

바가 닫힐 때:

```
E[p_buy] ← α_imbl × p_buy_관찰값 + (1 - α_imbl) × E[p_buy]
E[v]     ← α_imbl × 틱당_평균_거래량 + (1 - α_imbl) × E[v]
E[T]     ← α_size × T_bar + (1 - α_size) × E[T]
E[T]     = clamp(E[T], size_min, size_max)
threshold ← E[T] × E[v] × (2·E[p_buy] - 1)
```

참고: `E[v]`는 일반적인 거래 규모에 대한 사전 추정값이 없으므로 첫 번째 관찰된 거래 거래량으로 시드된다.

## 하이퍼파라미터

VIBS는 `TibsConfig` 구조체를 재사용한다.

| 파라미터 | 설정 키 | 기본값 | 설명 |
|---------|---------|--------|------|
| 초기 바 크기 | `initial_size` | 100.0 | 시작 `E[T]` (바당 틱 수) |
| 초기 매수 확률 | `initial_p_buy` | 0.7 | 시작 `E[p_buy]` |
| 크기 EWMA 알파 | `alpha_size` | 0.1 | `E[T]`의 평활 계수 |
| 거래량/확률 EWMA 알파 | `alpha_imbl` | 0.1 | `E[v]`와 `E[p_buy]` 모두의 평활 계수 |
| 크기 제한 | `size_min_pct` / `size_max_pct` | 초기값의 ±10% | `E[T]`의 제한 범위 |

### TIBS와의 핵심 차이

VIBS에는 임계값을 거래량 인식으로 만드는 추가 상태 변수 `E[v]` (틱당 예상 거래량)가 있다. 0으로 초기화되고 첫 번째 틱에서 시드된다.

## 출력

닫힌 각 바는 `Candle` protobuf 메시지로 방출된다:

| 필드 | 내용 |
|------|------|
| `symbol` | 거래 쌍 |
| `timestamp` | 바 시작 시간 (밀리초) |
| `open`, `high`, `low`, `close` | OHLC 가격 |
| `volume` | 총 거래량 |
| `interval` | 레이블 (예: `vib_small`, `vib_large`) |
| `buy_ticks` | 매수자 주도 거래 수 |
| `sell_ticks` | 매도자 주도 거래 수 |
| `total_ticks` | 총 거래 수 |
| `theta` | 최종 누적 부호 있는 거래량 불균형 (부동 소수점) |

참고: TIBS의 theta가 정수(틱 수)인 것과 달리 VIBS theta는 부동 소수점(거래량 가중)이다.

## 서비스 변형

- **vibs_small** (`port_vibs_small`): `initial_size = 100`
- **vibs_large** (`port_vibs_large`): `initial_size = 250`

## 영속화

VIBS 바는 TimescaleDB의 `warehouse.bar__volume_imbalance` 테이블에 저장된다. `interval` 컬럼으로 small/large 프로필을 구분한다.

## TIBS와의 비교

| 관점 | TIBS | VIBS |
|------|------|------|
| 불균형 단위 | 틱 수 | 거래량 (호가/기본 수량) |
| 대규모 거래 민감도 | 모든 틱 동일 | 크기에 비례 |
| 임계값 구성 요소 | E[T] × E[불균형] | E[T] × E[v] × E[불균형] |
| 적합한 용도 | 틱 수준 방향 편향 감지 | 거래량 가중 흐름 감지 |
| Theta 의미 | 순 틱 수 (정수) | 순 부호 거래량 (부동 소수점) |

## 참고 문헌

- López de Prado, M. (2018). *Advances in Financial Machine Learning*. Wiley. 2장: Financial Data Structures.
