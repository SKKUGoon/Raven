syntax = "proto3";

package raven;

// Market Data Service for streaming data to clients
service MarketData {
    // Subscribe to market data for a specific symbol
    rpc Subscribe(MarketDataRequest) returns (stream MarketDataMessage);
}

message MarketDataRequest {
    string symbol = 1;
    DataType data_type = 2;
    // Trading venue (e.g. BINANCE_SPOT, BINANCE_FUTURES).
    // Required when the producer is multi-venue.
    string venue = 3;
}

enum DataType {
    UNKNOWN = 0;
    ORDERBOOK = 1;
    TRADE = 2;
    CANDLE = 3;
    FUNDING = 4;
    TICKER = 5;           // Options ticker (OI, IV, mark, etc.)
    PRICE_INDEX = 6;      // Underlying index (e.g. btc_usd)
    LIQUIDATION = 7;      // Forced liquidation event
    OPEN_INTEREST = 8;    // Futures open interest snapshot
}

// Market data types
message OrderBookSnapshot {
    string symbol = 1;
    int64 timestamp = 2;
    repeated PriceLevel bids = 3;
    repeated PriceLevel asks = 4;
    int64 sequence = 5;
}

message PriceLevel {
    double price = 1;
    double quantity = 2;
}

message Trade {
    string symbol = 1;
    int64 timestamp = 2;
    double price = 3;
    double quantity = 4;
    string side = 5;
    string trade_id = 6;
}

message Candle {
    string symbol = 1;
    int64 timestamp = 2;
    double open = 3;
    double high = 4;
    double low = 5;
    double close = 6;
    double volume = 7;
    string interval = 8;
    uint64 buy_ticks = 9;
    uint64 sell_ticks = 10;
    uint64 total_ticks = 11;
    double theta = 12;
}

message FundingRate {
    string symbol = 1;
    int64 timestamp = 2;
    double rate = 3;
    int64 next_funding_time = 4;
    double mark_price = 5;
    double index_price = 6;
}

// Forced liquidation event (Binance Futures forceOrder).
message Liquidation {
    string symbol = 1;
    int64 timestamp = 2;
    string side = 3;        // "buy" or "sell" (liquidated side)
    double price = 4;       // average fill price
    double quantity = 5;    // original quantity
}

// Futures open interest snapshot.
message OpenInterest {
    string symbol = 1;
    int64 timestamp = 2;
    double open_interest = 3;       // in contracts
    double open_interest_value = 4; // notional in quote currency
}

// Options ticker from Deribit (open interest, IV, mark, best bid/ask).
message OptionsTicker {
    string symbol = 1;
    int64 timestamp = 2;
    double open_interest = 3;
    double mark_iv = 4;
    double best_bid_price = 5;
    double best_ask_price = 6;
    double mark_price = 7;
    double underlying_price = 8;
    double last_price = 9;
    double bid_iv = 10;
    double ask_iv = 11;
}

// Underlying price index (e.g. deribit_price_index.btc_usd).
message PriceIndex {
    string index_name = 1;
    double price = 2;
    int64 timestamp = 3;
}

message WalletUpdate {
    string user_id = 1;
    int64 timestamp = 2;
    repeated Balance balances = 3;
}

message Balance {
    string asset = 1;
    double available = 2;
    double locked = 3;
}

message MarketDataMessage {
    // Backwards-compatibility field (historically used inconsistently).
    // We keep emitting this as the producer service name for older consumers.
    string exchange = 6;
    // Trading venue (e.g. BINANCE_SPOT, BINANCE_FUTURES).
    string venue = 7;
    // Producer service name (e.g. binance_spot, raven_timebar).
    string producer = 8;
    oneof data {
        OrderBookSnapshot orderbook = 1;
        Trade trade = 2;
        Candle candle = 3;
        FundingRate funding = 4;
        WalletUpdate wallet = 5;
        OptionsTicker options_ticker = 9;
        PriceIndex price_index = 10;
        Liquidation liquidation = 11;
        OpenInterest open_interest = 12;
    }
}
